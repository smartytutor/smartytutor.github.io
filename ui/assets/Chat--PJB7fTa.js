import{j as l}from"./jsx-runtime-DiklIkkE.js";import{c as A}from"./clsx-B-dksMZM.js";import{A as D}from"./Answer-PL8H0T0r.js";import{r as m}from"./index-DRjF_FHU.js";import{a as j}from"./VoiceoverProvider-CSBJPItj.js";import{M as h}from"./Message-BVAFNPDt.js";import{m as E}from"./proxy-BjE8Ig1W.js";const N=()=>{const e=m.useContext(j);if(!e)throw new Error("useVoiceover must be used within a VoiceoverProvider");return e},y=({token:e,isRevealed:t,itemKey:n})=>{const r=e.trim()==="";return l.jsx("span",{className:t||r?"opacity-100":"opacity-25",style:{display:r?"inline":"inline-block",transition:"opacity 800ms ease-out"},children:e},n)};y.__docgenInfo={description:"Компонент для отображения одного анимированного токена (слова/пробела)",methods:[],displayName:"AnimatedToken",props:{token:{required:!0,tsType:{name:"string"},description:""},isRevealed:{required:!0,tsType:{name:"boolean"},description:""},itemKey:{required:!0,tsType:{name:"union",raw:"string | number",elements:[{name:"string"},{name:"number"}]},description:""}}};const S=({text:e,revealedWordIndices:t})=>{let n=0;return l.jsx(l.Fragment,{children:e.map((r,s)=>{const a=r.split(/(\s+)/),o=l.jsx("p",{children:a.map((i,c)=>{const u=n;return n++,l.jsx(y,{token:i,isRevealed:t.has(u),itemKey:`${s}-${c}`},`${s}-${c}`)})},s);return s<e.length-1&&n++,o})})};S.__docgenInfo={description:"Компонент для отображения многострочного анимированного текста",methods:[],displayName:"AnimatedMultilineText",props:{text:{required:!0,tsType:{name:"Array",elements:[{name:"string"}],raw:"string[]"},description:""},revealedWordIndices:{required:!0,tsType:{name:"Set",elements:[{name:"number"}],raw:"Set<number>"},description:""}}};const R=({tokens:e,revealedWordIndices:t})=>l.jsx("span",{children:e.map((n,r)=>l.jsx(y,{token:n,isRevealed:t.has(r),itemKey:r},r))});R.__docgenInfo={description:"Компонент для отображения однострочного анимированного текста",methods:[],displayName:"AnimatedSingleLineText",props:{tokens:{required:!0,tsType:{name:"Array",elements:[{name:"string"}],raw:"string[]"},description:""},revealedWordIndices:{required:!0,tsType:{name:"Set",elements:[{name:"number"}],raw:"Set<number>"},description:""}}};const I=({text:e})=>Array.isArray(e)?l.jsx(l.Fragment,{children:e.map((t,n)=>l.jsx("p",{children:t},n))}):l.jsx("span",{children:e});I.__docgenInfo={description:"Компонент для отображения статичного текста (без анимации)",methods:[],displayName:"StaticText",props:{text:{required:!0,tsType:{name:"union",raw:"string | string[]",elements:[{name:"string"},{name:"Array",elements:[{name:"string"}],raw:"string[]"}]},description:""}}};const p={DEFAULT_WORDS_PER_SECOND:2.5,AUDIO_TIME_USAGE_RATIO:.92,INITIAL_DELAY:0,SHORT_WORD_THRESHOLD:3,LONG_WORD_THRESHOLD:8,SHORT_WORD_MULTIPLIER:.88,LONG_WORD_MULTIPLIER:1.18,LINE_BREAK_PAUSE:100},g=e=>e.split(/\s+/).filter(t=>t.trim()!==""),M=(e,t,n)=>{let r=0;return e.map(a=>g(a).length).map(a=>{const o=a/t,i=n*o,c=r;return r+=i,{startTime:c*1e3,duration:i*1e3,wordsCount:a}})},T=e=>{const t=e.trim().length;return t<=p.SHORT_WORD_THRESHOLD?p.SHORT_WORD_MULTIPLIER:t>=p.LONG_WORD_THRESHOLD?p.LONG_WORD_MULTIPLIER:1},P=(e,t)=>{let n=0;for(let r=0;r<t.length;r++){const s=g(t[r]);if(n+s.length>e)return r;n+=s.length}return t.length-1},b=(e,t,n)=>{let r=0;for(let s=0;s<t;s++)r+=g(n[s]).length;return e-r},k=(e,t,n,r)=>{const{baseTimePerWord:s,lineTimings:a,useAdaptiveSpeed:o}=r;if(!o)return s*T(t);if(Array.isArray(n)&&a.length>0){const i=P(e,n),c=b(e,i,n),u=a[i];if(u){let f=1e3/(u.wordsCount/(u.duration/1e3));return f*=T(t),c===0&&i>0&&(f+=p.LINE_BREAK_PAUSE),f}}return s*T(t)},v=(e,t,n)=>m.useMemo(()=>{if(!t||t<=0)return{baseTimePerWord:1e3/p.DEFAULT_WORDS_PER_SECOND,lineTimings:[],useAdaptiveSpeed:!1};const r=n,s=t/1e3;if(Array.isArray(e)){const a=s*p.AUDIO_TIME_USAGE_RATIO,o=M(e,r,a);return{baseTimePerWord:1e3/p.DEFAULT_WORDS_PER_SECOND,lineTimings:o,useAdaptiveSpeed:!0}}else{const a=s*p.AUDIO_TIME_USAGE_RATIO;return{baseTimePerWord:1e3/Math.max(1,r/a),lineTimings:[],useAdaptiveSpeed:!0}}},[t,n,e]),C=(e,t,n,r,s,a,o,i)=>{const c=m.useRef(!1);m.useEffect(()=>{c.current=!1},[e,r]),m.useEffect(()=>{if(!e){i(new Set);return}if(t!==e||!n||r.length===0)return;let u=0,d;const f=()=>{if(u<r.length){const _=r[u];i(W=>new Set([...W,_]));const x=s[_],L=k(u,x,a,o);u++,d=setTimeout(f,L)}};return c.current=!0,d=setTimeout(f,p.INITIAL_DELAY),()=>{d&&clearTimeout(d)}},[t,n,e,r,s,a,o,i]),m.useEffect(()=>{if(!e||!c.current)return;(t!==e||!n)&&r.length>0&&(i(new Set(r)),c.current=!1)},[t,n,e,r,i])},U=(e,t)=>{const[n,r]=m.useState(new Set);return m.useEffect(()=>{r(new Set)},[e,t]),{revealedWordIndices:n,setRevealedWordIndices:r}},q=e=>{const t=m.useMemo(()=>Array.isArray(e)?e.join(" "):e,[e]),n=m.useMemo(()=>t.split(/(\s+)/),[t]),r=m.useMemo(()=>{const s=[];return n.forEach((a,o)=>{a.trim()!==""&&s.push(o)}),s},[n]);return{fullText:t,tokens:n,wordIndices:r}},O=({text:e,voiceover:t})=>{const{currentAudio:n,isPlaying:r,audioDuration:s}=N(),{revealedWordIndices:a,setRevealedWordIndices:o}=U(e,t),{tokens:i,wordIndices:c}=q(e),u=v(e,s,c.length);return C(t,n,r,c,i,e,u,o),t?Array.isArray(e)?l.jsx(S,{text:e,revealedWordIndices:a}):l.jsx(R,{tokens:i,revealedWordIndices:a}):l.jsx(I,{text:e})};O.__docgenInfo={description:"",methods:[],displayName:"KaraokeText",props:{text:{required:!0,tsType:{name:"union",raw:"string | string[]",elements:[{name:"string"},{name:"Array",elements:[{name:"string"}],raw:"string[]"}]},description:""},voiceover:{required:!1,tsType:{name:"string"},description:""}}};const H=({variant:e="default",messages:t,thinking:n=!1})=>l.jsxs("div",{className:"relative flex flex-col-reverse gap-y-3 pl-2 pr-4 xl:pr-6",children:[n&&l.jsx(E.div,{initial:{opacity:0,scale:0},animate:{opacity:1,scale:1},layout:!0,children:l.jsx(h,{variant:"thinking"})}),t.map(({id:r,text:s,correct:a,answer:o,pinned:i,voiceover:c},u)=>l.jsx(E.div,{initial:{opacity:0,scale:0},animate:{opacity:1,scale:1},layout:!0,transition:{delay:t.length>1&&u===0?.1:0,type:"spring",stiffness:300,damping:27.5},className:A(i&&"sticky top-1 z-50"),children:l.jsxs(h,{callout:e==="default"&&!o,variant:u===0?"default":"inactive",correct:a,pinned:i,className:A(e==="default"&&i&&"opacity-100",e==="default"&&!i&&u===1&&"opacity-80",e==="default"&&!i&&u===2&&"opacity-60",e==="default"&&!i&&u>2&&"opacity-40",o&&"translate-x-3 xl:translate-x-5"),children:[s&&l.jsx(O,{text:s,voiceover:c}),o==null?void 0:o.map((d,f)=>l.jsx(D,{variant:d.variant,children:Array.isArray(d.text)?d.text.join("<br>"):d.text},f))]})},r))]});H.__docgenInfo={description:"",methods:[],displayName:"Chat",props:{variant:{required:!1,tsType:{name:"union",raw:"'default' | 'history'",elements:[{name:"literal",value:"'default'"},{name:"literal",value:"'history'"}]},description:"",defaultValue:{value:"'default'",computed:!1}},messages:{required:!0,tsType:{name:"Array",elements:[{name:"Message"}],raw:"Message[]"},description:""},thinking:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}}}};export{H as C,O as K,N as u};

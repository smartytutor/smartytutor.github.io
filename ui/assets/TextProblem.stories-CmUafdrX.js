import{j as p}from"./jsx-runtime-DR9Q75dM.js";import"./Action-DQ72ZiUY.js";import"./Answer-CpHO1qYv.js";import"./Button-CGecWSMn.js";import"./Chat-CUlhg49f.js";import"./Icon-DNOHRIBS.js";import"./Input-0sRJfh9S.js";import{r as f}from"./index-DRjF_FHU.js";import"./Menu-DuHofHgY.js";import"./Message-ByLECGpj.js";import"./ProgressBar-Dhx3fOxm.js";import"./Smartik-Dfzh54ZR.js";import{I as A,U as _}from"./SideSlide-Dn38-Xws.js";import B from"./Chat.stories-lQbS4D1C.js";import{Default as H}from"./ProgressBar.stories-DVUOzv-A.js";import{n as k}from"./redux-toolkit.modern-DEr0YuQG.js";import{u as P,a as g,c as T}from"./index-BM9kYpov.js";import"./VoiceoverProvider-i68q2e-2.js";import{u as U}from"./useImagePreloader-C1UmUM2_.js";import"./DraggableToken-VOVcS7y6.js";import{p as F,l as j,P as O,c as $,d as q,a as z}from"./Solution-wkr2WZzY.js";import{H as L}from"./Highlighted-6-cdO6i-.js";import"./PopoverInput-CjNRUc2A.js";import{D as Q,b as V}from"./Sign-C0BDR2GM.js";import"./Token-WdqJ7wEV.js";import"./clsx-B-dksMZM.js";import"./proxy-C00yw4cG.js";import"./Deck-CiBVLBkl.js";import"./AnimatedCard-2cVL3gan.js";import"./NumeralFace-BKM8_hJa.js";import"./_arrayLikeKeys-BOaknIRz.js";import"./defaults-BleV3Q12.js";import"./keysIn-Bb7DVGF9.js";const y=""+new URL("scheme-CvuQwA6x.svg",import.meta.url).href,G=()=>{const[s,o]=f.useState(new Map),r=f.useCallback((t,c)=>{o(i=>{const l=new Map(i);return c?l.set(t,c):l.delete(t),l})},[]),n=f.useMemo(()=>Array.from(s.values()),[s]);return{registerSlot:r,slotRefs:n,slotRefMap:s}};function J(){const s=P(),o=g(t=>t.TextProblem.solution.steps),r=g(t=>t.TextProblem.solution.activeStepIndex),n=(t,c,i)=>{s(T.placeToken({slotId:t,token:{id:c,variant:"operand",value:i}}))};return f.useEffect(()=>{if(r===o.length-1)return;o.slice(0,r+1).every(i=>i.expression.filter(l=>l.type==="slot").every(l=>l.item.token))&&s(T.setStep(r+1))},[r,s,o]),{steps:o,activeStepIndex:r,handleSlotInput:n}}const D=s=>{const o={},r={replace:n=>{if(n.type==="tag"){if(n.tagName==="operand"){const{id:t}=n.attribs;return o[t]={id:t,variant:"operand",value:Number(j.domToReact(n.children,r)),reusable:!1},p.jsx(O,{id:t})}if(n.tagName==="highlighted")return p.jsx(L,{children:j.domToReact(n.children,r)})}}};return{tokens:o,text:F(s,r)}};function K(s){const o=g(e=>e.TextProblem.text),r=f.useMemo(()=>D(o),[o]),n=g(e=>e.TextProblem.solution.steps),[t,c]=f.useState(r.tokens),i=n.flatMap(e=>e.expression.filter(m=>m.type==="slot")).map(e=>e.item.token).filter(e=>typeof e<"u");return{tokens:f.useMemo(()=>{const e=new Map;return[...s,...Object.values(t),...i].forEach(m=>!e.has(m.id)&&e.set(m.id,m)),Array.from(e.values())},[s,i,t]),taskTokens:t,resetTokens:e=>{c(m=>A(m,a=>e.includes(a.id)?{...a,inactive:!1,resetTimestamp:Date.now()}:a))}}}function W(s,o,r){const n=P();return{handleTokenDrop:(c,{point:i})=>{var m;if(c.stopPropagation(),!o.length)return;const l=o.find(a=>{const u=a.getBoundingClientRect();if(i.x>=u.left&&i.x<=u.right&&i.y>=u.top&&i.y<=u.bottom)return a});if(!l)return!1;const d=(m=r.flatMap(a=>a.expression).find(a=>a.type==="slot"&&a.item.id===l.id))==null?void 0:m.item;if(!(d!=null&&d.accepts.includes("drop")))return!1;const e=s.find(a=>{var u,h;return a.id===((h=(u=c.target.parentElement)==null?void 0:u.closest("[id]"))==null?void 0:h.id)});return d&&e&&d.variant===e.variant?(n(T.placeToken({slotId:d.id,token:e})),!0):!1}}}const M=[{id:k(4),variant:"sign",value:"add"},{id:k(4),variant:"sign",value:"subtract"},{id:k(4),variant:"sign",value:"multiply"},{id:k(4),variant:"sign",value:"divide"}],N=()=>{const s=P();U({scheme:y});const o=f.useRef(null),{slotRefs:r,registerSlot:n}=G(),{tokens:t,taskTokens:c,resetTokens:i}=K(M),{steps:l,activeStepIndex:d,handleSlotInput:e}=J(),{handleTokenDrop:m}=W(t,r,l),a=g(x=>x.TextProblem.text),u=f.useMemo(()=>D(a),[a]),h=g(x=>x.TextProblem.solution.answer),E=x=>{s(T.redoStep(x));const C=l.slice(x).flatMap(b=>b.expression.filter(v=>v.type==="slot")).filter(Boolean).map(b=>{var v;return(v=b.item.token)==null?void 0:v.id});i(C),s(T.setStep(x))};return p.jsx(Q.Provider,{value:{dragConstraints:o,onDragEnd:m},children:p.jsxs("div",{className:"mx-8 my-20 flex flex-col gap-y-8 2xl:mx-32",ref:o,children:[p.jsx($,{parsedText:u.text,tokens:c}),p.jsxs("div",{className:"flex gap-x-14 pr-14",children:[p.jsx("img",{src:y,className:"w-1/3"}),p.jsxs("div",{className:"flex-1",children:[p.jsx("div",{className:"absolute right-5 mt-2",children:p.jsx(q,{tokens:M})}),p.jsx(V.Provider,{value:{registerSlot:n,onSlotInput:e},children:p.jsx(z,{steps:l,answer:h,activeStepIndex:d,onSlotInput:e,onRedo:E})})]})]})]})})};N.__docgenInfo={description:"",methods:[],displayName:"TextProblem"};const Ne={title:"Тренажёры/TextProblem/TextProblem",component:N,tags:["!autodocs"],parameters:{layout:"fullscreen"},decorators:s=>p.jsx(_,{chat:{messages:B.args.messages},progressBar:H.args,children:p.jsx(s,{})})},S={};var I,R,w;S.parameters={...S.parameters,docs:{...(I=S.parameters)==null?void 0:I.docs,source:{originalSource:"{}",...(w=(R=S.parameters)==null?void 0:R.docs)==null?void 0:w.source}}};const Ee=["TextProblem"];export{S as TextProblem,Ee as __namedExportsOrder,Ne as default};

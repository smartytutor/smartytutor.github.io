import{j as R}from"./jsx-runtime-DR9Q75dM.js";import{r as g}from"./index-DRjF_FHU.js";const $=8e3,N=1e4,O=6,V=2,X=3,W=350,D=0,p=new Set,T=new Set,h=new Map,_=new Set,P=new Map;function j(e,t,r){return new Promise((a,s)=>{const n=setTimeout(()=>{console.warn(`[assetLoader] ⏰ Timeout after ${t}ms for:`,r),a(void 0)},t);e.then(o=>{clearTimeout(n),a(o)}).catch(o=>{clearTimeout(n),s(o)})})}async function q(e){if(!e||p.has(e))return;const t=h.get(e);if(t)return t;console.log("[assetLoader] ⬇️  Loading image:",e);const r=new Promise((a,s)=>{const n=new Image;n.onload=()=>a(),n.onerror=()=>s(new Error(`[assetLoader] Image failed: ${e}`)),n.src=e}).then(()=>{p.add(e),h.delete(e),console.log("[assetLoader] ✅ Image loaded:",e)}).catch(a=>{throw T.add(e),h.delete(e),console.warn("[assetLoader] ❌ Image failed:",e,a),a});return h.set(e,r),r}async function z(e){if(!e||p.has(e))return;const t=h.get(e);if(t)return t;console.log("[assetLoader] ⬇️  Loading audio (fetch):",e);const r=fetch(e).then(async a=>{if(!a.ok)throw new Error(`[assetLoader] Audio fetch failed: ${e} - ${a.status}`);const s=await a.blob(),n=URL.createObjectURL(s);P.set(e,n)}).then(()=>{p.add(e),h.delete(e),console.log("[assetLoader] ✅ Audio loaded (blob):",e)}).catch(a=>{throw T.add(e),h.delete(e),console.warn("[assetLoader] ❌ Audio failed:",e,a),a});return h.set(e,r),r}function Y(e){return P.get(e)}async function C(e,t,r={}){const s=Array.from(new Set(e.filter(Boolean))).filter(i=>!p.has(i)&&!h.has(i)),n=s.length;if(n===0)return;let o=0;const{timeoutMs:u=t==="audio"?N:$,onProgress:c}=r,f=r.maxConcurrent??(t==="audio"?V:O),m=r.yieldToMainQueueMs??D,w=t==="image"?q:z;console.groupCollapsed(`[assetLoader] Ensuring ${t} assets (${n})`),s.forEach(i=>console.log(" -",i)),console.groupEnd();let E=0;const A=async()=>{for(;E<s.length;){const i=E++,v=s[i];try{m>0&&await new Promise(d=>setTimeout(d,m)),await j(w(v),u,v)}finally{o+=1,c==null||c(o,n,v)}}},l=Array.from({length:Math.min(f,s.length)},()=>A());await Promise.all(l),console.log(`[assetLoader] ✅ Ensured ${t} assets: ${o}/${n}`)}function B(e){var s,n;const t=new Set,r=new Set;switch((o=>{if(!o)return;(Array.isArray(o)?o:[o]).forEach(c=>(c==null?void 0:c.src)&&r.add(c.src))})(e.sfx),e.type){case"message":{e.voiceover&&r.add(e.voiceover);break}case"action":{(s=e.action)!=null&&s.voiceover&&r.add(e.action.voiceover);break}case"select":{e.options.forEach(o=>{o.voiceover&&r.add(o.voiceover)});break}case"comics":{e.slides.forEach(o=>{o.image&&t.add(o.image),o.voiceover&&r.add(o.voiceover)});break}case"sticker":{e.url&&t.add(e.url);break}case"showMeme":{e.url&&t.add(e.url);break}case"attachInteractive":{const o=e.props;o&&typeof o.backgroundImage=="string"&&t.add(o.backgroundImage);break}case"playSfx":{e.src&&r.add(e.src);break}case"showSideSlide":{e.url&&t.add(e.url),(n=e.phrases)==null||n.forEach(o=>o.voiceover&&r.add(o.voiceover));break}}return{images:Array.from(t),audios:Array.from(r)}}function F(e,t,r){const a=[];let s=t;for(;s&&a.length<r;){const n=e[s];if(!n)break;a.push(s),s=n.next}return a}async function J(e,t,r,a={}){const s=`${t}::${r}`;if(_.has(s)){console.log("[assetLoader] ⏭️  Skip prebuffer (already done):",s);return}const n=F(e,t,r),o=new Set,u=new Set;console.groupCollapsed(`[assetLoader] 🎬 Prebuffer first ${r} events from "${t}"`),console.log("Event sequence:",n),n.forEach(w=>{const E=e[w];if(!E)return;const{images:A,audios:l}=B(E);A.forEach(i=>o.add(i)),l.forEach(i=>u.add(i))}),console.log("Images to preload:",Array.from(o)),console.log("Audio to preload:",Array.from(u)),console.groupEnd();const c=o.size+u.size;if(c===0)return;let f=0;const m=(w,E,A)=>{var l;f+=1,(l=a.onProgress)==null||l.call(a,f,c,A)};await Promise.all([C(Array.from(o),"image",{timeoutMs:a.timeoutMs,onProgress:m,maxConcurrent:a.maxConcurrentImage}),C(Array.from(u),"audio",{timeoutMs:a.timeoutMs,onProgress:m,maxConcurrent:a.maxConcurrentAudio})]),console.log("[assetLoader] ✅ Prebuffer completed:",{events:n.length,images:o.size,audios:u.size}),_.add(s)}const G=g.createContext(null),H=({children:e})=>{const[t,r]=g.useState(null),[a,s]=g.useState(!1),[n,o]=g.useState(!1),[u,c]=g.useState(null),f=g.useRef(null),m=g.useCallback(()=>{f.current&&(f.current.pause(),f.current.currentTime=0),r(null),s(!1),o(!1),c(null)},[]),w=g.useCallback(async(l,i=!0)=>{m();const v=Y(l)??l,d=new Audio(v);return f.current=d,r(l),o(i),s(!1),new Promise((x,k)=>{const L=()=>{c(d.duration*1e3)},S=()=>{s(!1),o(!1),M(),x()},y=()=>{const U=new Error(`Audio loading failed: ${l}`);s(!1),o(!1),c(null),M(),k(U)},b=()=>{s(!0)},I=()=>{s(!1)},M=()=>{d.removeEventListener("loadedmetadata",L),d.removeEventListener("ended",S),d.removeEventListener("error",y),d.removeEventListener("playing",b),d.removeEventListener("pause",I)};d.addEventListener("loadedmetadata",L),d.addEventListener("ended",S),d.addEventListener("error",y),d.addEventListener("playing",b),d.addEventListener("pause",I),d.play().catch(y)})},[m]),E=g.useCallback(()=>{o(!1)},[]),A={currentAudio:t,isPlaying:a,isBlocked:n,audioDuration:u,playVoiceover:w,stopVoiceover:m,unblock:E};return R.jsx(G.Provider,{value:A,children:e})};H.__docgenInfo={description:"",methods:[],displayName:"VoiceoverProvider",props:{children:{required:!0,tsType:{name:"ReactReactNode",raw:"React.ReactNode"},description:""}}};export{$ as A,X as P,W as T,H as V,G as a,N as b,B as c,V as d,C as e,O as f,J as p};

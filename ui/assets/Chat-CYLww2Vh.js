import{j as l}from"./jsx-runtime-DR9Q75dM.js";import{c as A}from"./clsx-B-dksMZM.js";import{A as W}from"./Answer-CpHO1qYv.js";import{r as m}from"./index-DRjF_FHU.js";import{a as L}from"./VoiceoverProvider-i68q2e-2.js";import{M as x}from"./Message-ByLECGpj.js";import{m as D}from"./proxy-C00yw4cG.js";const N=()=>{const e=m.useContext(L);if(!e)throw new Error("useVoiceover must be used within a VoiceoverProvider");return e},g=({token:e,isRevealed:t,itemKey:n})=>{const r=e.trim()==="";return l.jsx("span",{className:t||r?"opacity-100":"opacity-25",style:{display:r?"inline":"inline-block",transition:"opacity 800ms ease-out"},children:e},n)};g.__docgenInfo={description:"Компонент для отображения одного анимированного токена (слова/пробела)",methods:[],displayName:"AnimatedToken",props:{token:{required:!0,tsType:{name:"string"},description:""},isRevealed:{required:!0,tsType:{name:"boolean"},description:""},itemKey:{required:!0,tsType:{name:"union",raw:"string | number",elements:[{name:"string"},{name:"number"}]},description:""}}};const _=({text:e,revealedWordIndices:t})=>{let n=0;return l.jsx(l.Fragment,{children:e.map((r,s)=>{const i=r.split(/(\s+)/),o=l.jsx("p",{children:i.map((c,a)=>{const u=n;return n++,l.jsx(g,{token:c,isRevealed:t.has(u),itemKey:`${s}-${a}`},`${s}-${a}`)})},s);return s<e.length-1&&n++,o})})};_.__docgenInfo={description:"Компонент для отображения многострочного анимированного текста",methods:[],displayName:"AnimatedMultilineText",props:{text:{required:!0,tsType:{name:"Array",elements:[{name:"string"}],raw:"string[]"},description:""},revealedWordIndices:{required:!0,tsType:{name:"Set",elements:[{name:"number"}],raw:"Set<number>"},description:""}}};const h=({tokens:e,revealedWordIndices:t})=>l.jsx("span",{children:e.map((n,r)=>l.jsx(g,{token:n,isRevealed:t.has(r),itemKey:r},r))});h.__docgenInfo={description:"Компонент для отображения однострочного анимированного текста",methods:[],displayName:"AnimatedSingleLineText",props:{tokens:{required:!0,tsType:{name:"Array",elements:[{name:"string"}],raw:"string[]"},description:""},revealedWordIndices:{required:!0,tsType:{name:"Set",elements:[{name:"number"}],raw:"Set<number>"},description:""}}};const I=({text:e})=>Array.isArray(e)?l.jsx(l.Fragment,{children:e.map((t,n)=>l.jsx("p",{children:t},n))}):l.jsx("span",{children:e});I.__docgenInfo={description:"Компонент для отображения статичного текста (без анимации)",methods:[],displayName:"StaticText",props:{text:{required:!0,tsType:{name:"union",raw:"string | string[]",elements:[{name:"string"},{name:"Array",elements:[{name:"string"}],raw:"string[]"}]},description:""}}};const d={DEFAULT_WORDS_PER_SECOND:2.5,AUDIO_TIME_USAGE_RATIO:.92,INITIAL_DELAY:300,SHORT_WORD_THRESHOLD:3,LONG_WORD_THRESHOLD:8,SHORT_WORD_MULTIPLIER:.88,LONG_WORD_MULTIPLIER:1.18,LINE_BREAK_PAUSE:100,TRANSITION_DURATION:800},y=e=>e.split(/\s+/).filter(t=>t.trim()!==""),j=(e,t,n)=>{let r=0;return e.map(i=>y(i).length).map(i=>{const o=i/t,c=n*o,a=r;return r+=c,{startTime:a*1e3,duration:c*1e3,wordsCount:i}})},f=e=>{const t=e.trim().length;return t<=d.SHORT_WORD_THRESHOLD?d.SHORT_WORD_MULTIPLIER:t>=d.LONG_WORD_THRESHOLD?d.LONG_WORD_MULTIPLIER:1},v=(e,t)=>{let n=0;for(let r=0;r<t.length;r++){const s=y(t[r]);if(n+s.length>e)return r;n+=s.length}return t.length-1},P=(e,t,n)=>{let r=0;for(let s=0;s<t;s++)r+=y(n[s]).length;return e-r},M=(e,t,n,r)=>{const{baseTimePerWord:s,lineTimings:i,useAdaptiveSpeed:o}=r;if(!o)return s*f(t);if(Array.isArray(n)&&i.length>0){const c=v(e,n),a=P(e,c,n),u=i[c];if(u){let p=1e3/(u.wordsCount/(u.duration/1e3));return p*=f(t),a===0&&c>0&&(p+=d.LINE_BREAK_PAUSE),p}}return s*f(t)},U=(e,t,n)=>m.useMemo(()=>{if(!t||t<=0)return{baseTimePerWord:1e3/d.DEFAULT_WORDS_PER_SECOND,lineTimings:[],useAdaptiveSpeed:!1};const r=n,s=t/1e3;if(Array.isArray(e)){const i=s*d.AUDIO_TIME_USAGE_RATIO,o=j(e,r,i);return{baseTimePerWord:1e3/d.DEFAULT_WORDS_PER_SECOND,lineTimings:o,useAdaptiveSpeed:!0}}else{const i=s*d.AUDIO_TIME_USAGE_RATIO;return{baseTimePerWord:1e3/Math.max(1,r/i),lineTimings:[],useAdaptiveSpeed:!0}}},[t,n,e]),b=(e,t,n,r,s,i,o,c)=>{m.useEffect(()=>{if(!e){c(new Set);return}if(t!==e||!n||r.length===0)return;let a=0,u;const T=()=>{if(a<r.length){const p=r[a];c(O=>new Set([...O,p]));const E=s[p],R=M(a,E,i,o);a++,u=setTimeout(T,R)}};return u=setTimeout(T,d.INITIAL_DELAY),()=>{u&&clearTimeout(u)}},[t,n,e,r,s,i,o,c])},C=(e,t)=>{const[n,r]=m.useState(new Set);return m.useEffect(()=>{r(new Set)},[e,t]),{revealedWordIndices:n,setRevealedWordIndices:r}},k=e=>{const t=m.useMemo(()=>Array.isArray(e)?e.join(" "):e,[e]),n=m.useMemo(()=>t.split(/(\s+)/),[t]),r=m.useMemo(()=>{const s=[];return n.forEach((i,o)=>{i.trim()!==""&&s.push(o)}),s},[n]);return{fullText:t,tokens:n,wordIndices:r}},S=({text:e,voiceover:t})=>{const{currentAudio:n,isPlaying:r,audioDuration:s}=N(),{revealedWordIndices:i,setRevealedWordIndices:o}=C(e,t),{tokens:c,wordIndices:a}=k(e),u=U(e,s,a.length);return b(t,n,r,a,c,e,u,o),t?Array.isArray(e)?l.jsx(_,{text:e,revealedWordIndices:i}):l.jsx(h,{tokens:c,revealedWordIndices:i}):l.jsx(I,{text:e})};S.__docgenInfo={description:"",methods:[],displayName:"KaraokeText",props:{text:{required:!0,tsType:{name:"union",raw:"string | string[]",elements:[{name:"string"},{name:"Array",elements:[{name:"string"}],raw:"string[]"}]},description:""},voiceover:{required:!1,tsType:{name:"string"},description:""}}};const q=({variant:e="default",messages:t})=>l.jsx("div",{className:"relative flex flex-col-reverse gap-y-3 pl-2 pr-4 xl:pr-6",children:t.map(({id:n,text:r,correct:s,answer:i,pinned:o,voiceover:c},a)=>l.jsx(D.div,{initial:{opacity:0,scale:0},animate:{opacity:1,scale:1},layout:!0,transition:{delay:t.length>1&&a===0?.1:0,type:"spring",stiffness:300,damping:27.5},className:A(o&&"sticky top-1 z-50"),children:l.jsxs(x,{callout:e==="default"&&!i,variant:a===0?"default":"inactive",correct:s,pinned:o,className:A(e==="default"&&o&&"opacity-100",e==="default"&&!o&&a===1&&"opacity-80",e==="default"&&!o&&a===2&&"opacity-60",e==="default"&&!o&&a>2&&"opacity-40",i&&"translate-x-3 xl:translate-x-5"),children:[r&&l.jsx(S,{text:r,voiceover:c}),i==null?void 0:i.map((u,T)=>l.jsx(W,{variant:u.variant,children:Array.isArray(u.text)?u.text.join("<br>"):u.text},T))]})},n))});q.__docgenInfo={description:"",methods:[],displayName:"Chat",props:{variant:{required:!1,tsType:{name:"union",raw:"'default' | 'history'",elements:[{name:"literal",value:"'default'"},{name:"literal",value:"'history'"}]},description:"",defaultValue:{value:"'default'",computed:!1}},messages:{required:!0,tsType:{name:"Array",elements:[{name:"Message"}],raw:"Message[]"},description:""}}};export{q as C,N as u};

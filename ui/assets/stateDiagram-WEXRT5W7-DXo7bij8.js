import{s as R,a as W,S as N}from"./chunk-GOYUR5SG-CorVhH2_.js";import{_ as f,c as t,d as H,l as S,e as P,k as z,ab as _,ac as U,a8 as C,u as F}from"./ScenarioGraphModal-CKXm_Gb2.js";import{G as O}from"./graph-DqGmUdv1.js";import{l as J}from"./layout-tQrnnZvA.js";import"./chunk-HPOVUXKZ-Du_C1ivT.js";import"./jsx-runtime-DiklIkkE.js";import"./index-DRjF_FHU.js";import"./Action-DUkQC_DA.js";import"./clsx-B-dksMZM.js";import"./Button-BGi-_Oof.js";import"./useAssetPreloader-lqYNbhtK.js";import"./SfxProvider-C05We5iG.js";import"./useSfx-BACfETso.js";import"./Icon-C_N4S_ZJ.js";import"./proxy-BjE8Ig1W.js";import"./Answer-PL8H0T0r.js";import"./Chat-RNtaA_Kh.js";import"./VoiceoverProvider-CSBJPItj.js";import"./Message-CGbUbVro.js";import"./Input-DcyMQBIt.js";import"./Menu-BCBPHnai.js";import"./ProgressBar-DX19bTZY.js";import"./Smartik-DnMQQPug.js";import"./UnsupportedResolution-vlWpwgAf.js";import"./index-DtnLUT1i.js";import"./redux-toolkit.modern-CeOX0_sF.js";import"./_arrayLikeKeys-BQo_jNKa.js";import"./index-0xIPAiCx.js";import"./NumeralFace-Ds693XiA.js";import"./Slot-CT1AWMYi.js";import"./Lot-DQsF8ln-.js";import"./constants-K3C4fZDC.js";import"./Module-BbZk3Jp-.js";import"./DraggableLot-BAYEXKcw.js";import"./defaults-mPm_OiqA.js";import"./LotPicker-B4IeDM1u.js";import"./Stack-RW0OyjXV.js";import"./LotPalette-CMrf6JxE.js";import"./DraggableToken-B8Igi4VB.js";import"./Sign-DADmf3_9.js";import"./Token-DuPhmN9g.js";import"./AnimatedCard-CCJgi9RF.js";import"./Deck-ngmnPlfX.js";import"./Highlighted-Z1bvx3uf.js";import"./iframe-CvFqCCxj.js";import"./index-DrFu-skq.js";import"./_baseUniq-Cg846NPU.js";import"./_basePickBy-9Mor9-su.js";var X=f(e=>e.append("circle").attr("class","start-state").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit).attr("cy",t().state.padding+t().state.sizeUnit),"drawStartState"),D=f(e=>e.append("line").style("stroke","grey").style("stroke-dasharray","3").attr("x1",t().state.textHeight).attr("class","divider").attr("x2",t().state.textHeight*2).attr("y1",0).attr("y2",0),"drawDivider"),Y=f((e,i)=>{const o=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+2*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.id),p=o.node().getBBox();return e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",p.width+2*t().state.padding).attr("height",p.height+2*t().state.padding).attr("rx",t().state.radius),o},"drawSimpleState"),I=f((e,i)=>{const o=f(function(c,B,w){const E=c.append("tspan").attr("x",2*t().state.padding).text(B);w||E.attr("dy",t().state.textHeight)},"addTspan"),n=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+1.3*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.descriptions[0]).node().getBBox(),g=n.height,x=e.append("text").attr("x",t().state.padding).attr("y",g+t().state.padding*.4+t().state.dividerMargin+t().state.textHeight).attr("class","state-description");let a=!0,s=!0;i.descriptions.forEach(function(c){a||(o(x,c,s),s=!1),a=!1});const y=e.append("line").attr("x1",t().state.padding).attr("y1",t().state.padding+g+t().state.dividerMargin/2).attr("y2",t().state.padding+g+t().state.dividerMargin/2).attr("class","descr-divider"),h=x.node().getBBox(),d=Math.max(h.width,n.width);return y.attr("x2",d+3*t().state.padding),e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",d+2*t().state.padding).attr("height",h.height+g+2*t().state.padding).attr("rx",t().state.radius),e},"drawDescrState"),$=f((e,i,o)=>{const p=t().state.padding,n=2*t().state.padding,g=e.node().getBBox(),x=g.width,a=g.x,s=e.append("text").attr("x",0).attr("y",t().state.titleShift).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.id),h=s.node().getBBox().width+n;let d=Math.max(h,x);d===x&&(d=d+n);let c;const B=e.node().getBBox();i.doc,c=a-p,h>x&&(c=(x-d)/2+p),Math.abs(a-B.x)<p&&h>x&&(c=a-(h-x)/2);const w=1-t().state.textHeight;return e.insert("rect",":first-child").attr("x",c).attr("y",w).attr("class",o?"alt-composit":"composit").attr("width",d).attr("height",B.height+t().state.textHeight+t().state.titleShift+1).attr("rx","0"),s.attr("x",c+p),h<=x&&s.attr("x",a+(d-n)/2-h/2+p),e.insert("rect",":first-child").attr("x",c).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",d).attr("height",t().state.textHeight*3).attr("rx",t().state.radius),e.insert("rect",":first-child").attr("x",c).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",d).attr("height",B.height+3+2*t().state.textHeight).attr("rx",t().state.radius),e},"addTitleAndBox"),q=f(e=>(e.append("circle").attr("class","end-state-outer").attr("r",t().state.sizeUnit+t().state.miniPadding).attr("cx",t().state.padding+t().state.sizeUnit+t().state.miniPadding).attr("cy",t().state.padding+t().state.sizeUnit+t().state.miniPadding),e.append("circle").attr("class","end-state-inner").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit+2).attr("cy",t().state.padding+t().state.sizeUnit+2)),"drawEndState"),Z=f((e,i)=>{let o=t().state.forkWidth,p=t().state.forkHeight;if(i.parentId){let n=o;o=p,p=n}return e.append("rect").style("stroke","black").style("fill","black").attr("width",o).attr("height",p).attr("x",t().state.padding).attr("y",t().state.padding)},"drawForkJoinState"),j=f((e,i,o,p)=>{let n=0;const g=p.append("text");g.style("text-anchor","start"),g.attr("class","noteText");let x=e.replace(/\r\n/g,"<br/>");x=x.replace(/\n/g,"<br/>");const a=x.split(z.lineBreakRegex);let s=1.25*t().state.noteMargin;for(const y of a){const h=y.trim();if(h.length>0){const d=g.append("tspan");if(d.text(h),s===0){const c=d.node().getBBox();s+=c.height}n+=s,d.attr("x",i+t().state.noteMargin),d.attr("y",o+n+1.25*t().state.noteMargin)}}return{textWidth:g.node().getBBox().width,textHeight:n}},"_drawLongText"),K=f((e,i)=>{i.attr("class","state-note");const o=i.append("rect").attr("x",0).attr("y",t().state.padding),p=i.append("g"),{textWidth:n,textHeight:g}=j(e,0,0,p);return o.attr("height",g+2*t().state.noteMargin),o.attr("width",n+t().state.noteMargin*2),o},"drawNote"),L=f(function(e,i){const o=i.id,p={id:o,label:i.id,width:0,height:0},n=e.append("g").attr("id",o).attr("class","stateGroup");i.type==="start"&&X(n),i.type==="end"&&q(n),(i.type==="fork"||i.type==="join")&&Z(n,i),i.type==="note"&&K(i.note.text,n),i.type==="divider"&&D(n),i.type==="default"&&i.descriptions.length===0&&Y(n,i),i.type==="default"&&i.descriptions.length>0&&I(n,i);const g=n.node().getBBox();return p.width=g.width+2*t().state.padding,p.height=g.height+2*t().state.padding,p},"drawState"),A=0,Q=f(function(e,i,o){const p=f(function(s){switch(s){case N.relationType.AGGREGATION:return"aggregation";case N.relationType.EXTENSION:return"extension";case N.relationType.COMPOSITION:return"composition";case N.relationType.DEPENDENCY:return"dependency"}},"getRelationType");i.points=i.points.filter(s=>!Number.isNaN(s.y));const n=i.points,g=_().x(function(s){return s.x}).y(function(s){return s.y}).curve(U),x=e.append("path").attr("d",g(n)).attr("id","edge"+A).attr("class","transition");let a="";if(t().state.arrowMarkerAbsolute&&(a=C(!0)),x.attr("marker-end","url("+a+"#"+p(N.relationType.DEPENDENCY)+"End)"),o.title!==void 0){const s=e.append("g").attr("class","stateLabel"),{x:y,y:h}=F.calcLabelPosition(i.points),d=z.getRows(o.title);let c=0;const B=[];let w=0,E=0;for(let u=0;u<=d.length;u++){const l=s.append("text").attr("text-anchor","middle").text(d[u]).attr("x",y).attr("y",h+c),m=l.node().getBBox();w=Math.max(w,m.width),E=Math.min(E,m.x),S.info(m.x,y,h+c),c===0&&(c=l.node().getBBox().height,S.info("Title height",c,h)),B.push(l)}let k=c*d.length;if(d.length>1){const u=(d.length-1)*c*.5;B.forEach((l,m)=>l.attr("y",h+m*c-u)),k=c*d.length}const r=s.node().getBBox();s.insert("rect",":first-child").attr("class","box").attr("x",y-w/2-t().state.padding/2).attr("y",h-k/2-t().state.padding/2-3.5).attr("width",w+t().state.padding).attr("height",k+t().state.padding),S.info(r)}A++},"drawEdge"),b,T={},V=f(function(){},"setConf"),tt=f(function(e){e.append("defs").append("marker").attr("id","dependencyEnd").attr("refX",19).attr("refY",7).attr("markerWidth",20).attr("markerHeight",28).attr("orient","auto").append("path").attr("d","M 19,7 L9,13 L14,7 L9,1 Z")},"insertMarkers"),et=f(function(e,i,o,p){b=t().state;const n=t().securityLevel;let g;n==="sandbox"&&(g=H("#i"+i));const x=n==="sandbox"?H(g.nodes()[0].contentDocument.body):H("body"),a=n==="sandbox"?g.nodes()[0].contentDocument:document;S.debug("Rendering diagram "+e);const s=x.select(`[id='${i}']`);tt(s);const y=p.db.getRootDoc();G(y,s,void 0,!1,x,a,p);const h=b.padding,d=s.node().getBBox(),c=d.width+h*2,B=d.height+h*2,w=c*1.75;P(s,B,w,b.useMaxWidth),s.attr("viewBox",`${d.x-b.padding}  ${d.y-b.padding} `+c+" "+B)},"draw"),at=f(e=>e?e.length*b.fontSizeFactor:1,"getLabelWidth"),G=f((e,i,o,p,n,g,x)=>{const a=new O({compound:!0,multigraph:!0});let s,y=!0;for(s=0;s<e.length;s++)if(e[s].stmt==="relation"){y=!1;break}o?a.setGraph({rankdir:"LR",multigraph:!0,compound:!0,ranker:"tight-tree",ranksep:y?1:b.edgeLengthFactor,nodeSep:y?1:50,isMultiGraph:!0}):a.setGraph({rankdir:"TB",multigraph:!0,compound:!0,ranksep:y?1:b.edgeLengthFactor,nodeSep:y?1:50,ranker:"tight-tree",isMultiGraph:!0}),a.setDefaultEdgeLabel(function(){return{}});const h=x.db.getStates(),d=x.db.getRelations(),c=Object.keys(h);for(const r of c){const u=h[r];o&&(u.parentId=o);let l;if(u.doc){let m=i.append("g").attr("id",u.id).attr("class","stateGroup");l=G(u.doc,m,u.id,!p,n,g,x);{m=$(m,u,p);let v=m.node().getBBox();l.width=v.width,l.height=v.height+b.padding/2,T[u.id]={y:b.compositTitleSize}}}else l=L(i,u,a);if(u.note){const m={descriptions:[],id:u.id+"-note",note:u.note,type:"note"},v=L(i,m,a);u.note.position==="left of"?(a.setNode(l.id+"-note",v),a.setNode(l.id,l)):(a.setNode(l.id,l),a.setNode(l.id+"-note",v)),a.setParent(l.id,l.id+"-group"),a.setParent(l.id+"-note",l.id+"-group")}else a.setNode(l.id,l)}S.debug("Count=",a.nodeCount(),a);let B=0;d.forEach(function(r){B++,S.debug("Setting edge",r),a.setEdge(r.id1,r.id2,{relation:r,width:at(r.title),height:b.labelHeight*z.getRows(r.title).length,labelpos:"c"},"id"+B)}),J(a),S.debug("Graph after layout",a.nodes());const w=i.node();a.nodes().forEach(function(r){r!==void 0&&a.node(r)!==void 0?(S.warn("Node "+r+": "+JSON.stringify(a.node(r))),n.select("#"+w.id+" #"+r).attr("transform","translate("+(a.node(r).x-a.node(r).width/2)+","+(a.node(r).y+(T[r]?T[r].y:0)-a.node(r).height/2)+" )"),n.select("#"+w.id+" #"+r).attr("data-x-shift",a.node(r).x-a.node(r).width/2),g.querySelectorAll("#"+w.id+" #"+r+" .divider").forEach(l=>{const m=l.parentElement;let v=0,M=0;m&&(m.parentElement&&(v=m.parentElement.getBBox().width),M=parseInt(m.getAttribute("data-x-shift"),10),Number.isNaN(M)&&(M=0)),l.setAttribute("x1",0-M+8),l.setAttribute("x2",v-M-8)})):S.debug("No Node "+r+": "+JSON.stringify(a.node(r)))});let E=w.getBBox();a.edges().forEach(function(r){r!==void 0&&a.edge(r)!==void 0&&(S.debug("Edge "+r.v+" -> "+r.w+": "+JSON.stringify(a.edge(r))),Q(i,a.edge(r),a.edge(r).relation))}),E=w.getBBox();const k={id:o||"root",label:o||"root",width:0,height:0};return k.width=E.width+2*b.padding,k.height=E.height+2*b.padding,S.debug("Doc rendered",k,a),k},"renderDoc"),it={setConf:V,draw:et},Qt={parser:W,get db(){return new N(1)},renderer:it,styles:R,init:f(e=>{e.state||(e.state={}),e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute},"init")};export{Qt as diagram};

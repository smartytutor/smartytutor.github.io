import{j as i}from"./jsx-runtime-CkxqCPlQ.js";import{u as P,a as h,b as g,P as A,s as C,U as _}from"./UI-CMiNKQAg.js";import"./Action-D9epNDd7.js";import"./Answer-BBzPdijR.js";import"./Button-_JJu6MQG.js";import"./Chat-DEgLH8Wu.js";import"./Icon-CA65L85m.js";import"./Input-CtlMo02g.js";import"./Menu-CSx_B6r2.js";import"./Message-CfDfO-e0.js";import"./ProgressBar-DvhAnra0.js";import"./Smartik-wiuCiDYb.js";import B from"./Chat.stories-Dt1u-T0d.js";import{Default as F}from"./ProgressBar.stories-Dg9lHho7.js";import{r as f}from"./index-DJO9vBfz.js";import{n as b}from"./redux-toolkit.modern-DEr0YuQG.js";import"./DraggableToken-XmdjouGl.js";import{p as H,l as j,P as O,c as U,d as V,a as $}from"./Solution-DPUUyPmu.js";import{H as q}from"./Highlighted-C9zu9qsC.js";import"./PopoverInput-W6sUtHDB.js";import{D as z,b as L}from"./Sign-M3dRSRBQ.js";import"./Token-BlVuBQLc.js";import{b as Q}from"./keys-V90hh7H8.js";import{b as G}from"./_baseForOwn-DbRuiFU9.js";import{b as J}from"./_baseIteratee-ZKJf9AJS.js";import"./clsx-B-dksMZM.js";import"./_isIterateeCall-ghNbYjRD.js";import"./_arrayLikeKeys-BP-wO3FV.js";import"./isArray-CqxlJJN4.js";import"./proxy-Bu-Muats.js";import"./index-tP14o_tB.js";import"./keysIn-aHi1SaSt.js";import"./_overArg-BLH_OBOE.js";const K=""+new URL("scheme-CvuQwA6x.svg",import.meta.url).href;function W(o,t){var r={};return t=J(t),G(o,function(n,e,c){Q(r,e,t(n,e,c))}),r}const X=()=>{const[o,t]=f.useState(new Map),r=f.useCallback((e,c)=>{t(l=>{const p=new Map(l);return c?p.set(e,c):p.delete(e),p})},[]),n=f.useMemo(()=>Array.from(o.values()),[o]);return{registerSlot:r,slotRefs:n,slotRefMap:o}};function Y(){const o=P(),t=h(e=>e.TextProblem.solution.steps),r=h(e=>e.TextProblem.solution.activeStepIndex),n=(e,c,l)=>{o(g.placeToken({slotId:e,token:{id:c,variant:"operand",value:l}}))};return f.useEffect(()=>{if(r===t.length-1)return;t.slice(0,r+1).every(l=>l.expression.filter(p=>p.type==="slot").every(p=>p.item.token))&&o(g.setStep(r+1))},[r,o,t]),{steps:t,activeStepIndex:r,handleSlotInput:n}}const I=o=>{const t={},r={replace:n=>{if(n.type==="tag"){if(n.tagName==="operand"){const{id:e}=n.attribs;return t[e]={id:e,variant:"operand",value:Number(j.domToReact(n.children,r)),reusable:!1},i.jsx(O,{id:e})}if(n.tagName==="highlighted")return i.jsx(q,{children:j.domToReact(n.children,r)})}}};return{tokens:t,text:H(o,r)}};function Z(o){const t=h(s=>s.TextProblem.text),r=f.useMemo(()=>I(t),[t]),n=h(s=>s.TextProblem.solution.steps),[e,c]=f.useState(r.tokens),l=n.flatMap(s=>s.expression.filter(m=>m.type==="slot")).map(s=>s.item.token).filter(s=>typeof s<"u");return{tokens:f.useMemo(()=>{const s=new Map;return[...o,...Object.values(e),...l].forEach(m=>!s.has(m.id)&&s.set(m.id,m)),Array.from(s.values())},[o,l,e]),taskTokens:e,resetTokens:s=>{c(m=>W(m,a=>s.includes(a.id)?{...a,inactive:!1,resetTimestamp:Date.now()}:a))}}}function ee(o,t,r){const n=P();return{handleTokenDrop:(c,{point:l})=>{var m;if(c.stopPropagation(),!t.length)return;const p=t.find(a=>{const u=a.getBoundingClientRect();if(l.x>=u.left&&l.x<=u.right&&l.y>=u.top&&l.y<=u.bottom)return a});if(!p)return!1;const d=(m=r.flatMap(a=>a.expression).find(a=>a.type==="slot"&&a.item.id===p.id))==null?void 0:m.item;if(!(d!=null&&d.accepts.includes("drop")))return!1;const s=o.find(a=>{var u,v;return a.id===((v=(u=c.target.parentElement)==null?void 0:u.closest("[id]"))==null?void 0:v.id)});return d&&s&&d.variant===s.variant?(n(g.placeToken({slotId:d.id,token:s})),!0):!1}}}const y=[{id:b(4),variant:"sign",value:"add"},{id:b(4),variant:"sign",value:"subtract"},{id:b(4),variant:"sign",value:"multiply"},{id:b(4),variant:"sign",value:"divide"}],D=()=>{const o=P(),t=f.useRef(null),{slotRefs:r,registerSlot:n}=X(),{tokens:e,taskTokens:c,resetTokens:l}=Z(y),{steps:p,activeStepIndex:d,handleSlotInput:s}=Y(),{handleTokenDrop:m}=ee(e,r,p),a=h(x=>x.TextProblem.text),u=f.useMemo(()=>I(a),[a]),v=h(x=>x.TextProblem.solution.answer),N=x=>{o(g.redoStep(x));const E=p.slice(x).flatMap(S=>S.expression.filter(T=>T.type==="slot")).filter(Boolean).map(S=>{var T;return(T=S.item.token)==null?void 0:T.id});l(E),setTimeout(()=>o(g.setStep(x)),500)};return i.jsx(z.Provider,{value:{dragConstraints:t,onDragEnd:m},children:i.jsxs("div",{className:"mx-8 my-20 flex flex-col gap-y-8 self-stretch",ref:t,children:[i.jsx(U,{parsedText:u.text,tokens:c}),i.jsxs("div",{className:"flex gap-x-14 pr-14",children:[i.jsx("img",{src:K,width:282}),i.jsxs("div",{className:"flex-1",children:[i.jsx("div",{className:"absolute right-5 mt-2",children:i.jsx(V,{tokens:y})}),i.jsx(L.Provider,{value:{registerSlot:n,onSlotInput:s},children:i.jsx($,{steps:p,answer:v,activeStepIndex:d,onSlotInput:s,onRedo:N})})]})]})]})})};D.__docgenInfo={description:"",methods:[],displayName:"TextProblem"};const _e={title:"TextProblem/TextProblem",component:D,tags:["!autodocs"],decorators:o=>i.jsx(A,{store:C,children:i.jsx("div",{className:"h-[657px] w-[1280px] shadow-2xl",children:i.jsx(_,{chat:{messages:B.args.messages},progressBar:F.args,children:i.jsx(o,{})})})})},k={args:void 0};var w,M,R;k.parameters={...k.parameters,docs:{...(w=k.parameters)==null?void 0:w.docs,source:{originalSource:`{
  args: undefined
}`,...(R=(M=k.parameters)==null?void 0:M.docs)==null?void 0:R.source}}};const Be=["TextProblem"];export{k as TextProblem,Be as __namedExportsOrder,_e as default};
